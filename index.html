<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <style>
        #main-image {
            display: block;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 10px;
            min-width: 300px;
            max-height: 500px;
        }
        .neighbour {
            height: 200px;
        }
    </style>

    <script typeof="text/javascript">
        var image_count = 0;
        var selected_image = 0;
        var arachnePath = "https://arachne.dainst.org/data";

        function updateDisplayedImage() {

            var selectedFilePath = dataPathList[imageListIndex];

            var xobj = new XMLHttpRequest();
            xobj.overrideMimeType("application/json");
            xobj.open('GET', selectedFilePath + '.neighbours.json', true);
            xobj.onreadystatechange = function () {

                if (xobj.readyState === 4 && xobj.status === 200) {
                    // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
                    var json_data = JSON.parse(xobj.responseText);
                    var main_image_element = document.querySelector('#main-image');

                    setImage(json_data['file_name'], main_image_element);

                    for(var index in json_data['neighbours']){
                        var neighbour = json_data['neighbours'][index];
                        var neighbour_element = document.querySelector('#neighbour-' + index);

                        setImage(neighbour['file_name'], neighbour_element)
                    }
                }
            };
            xobj.send(null);
        }

        function setImage(image_name, element) {
            var xobj = new XMLHttpRequest();
            xobj.open('GET', arachnePath + '/search?q=' + image_name);
            xobj.onreadystatechange = function () {
                if (xobj.readyState === 4) {
                    if (xobj.status === 200) {
                        var search_json = JSON.parse(xobj.responseText);

                        var imageUrl;

                        if (!search_json['entities']) {
                            imageUrl = 'icons/key-solid.svg'
                        }
                        else {
                            imageUrl = arachnePath + "/image/" + search_json['entities'][0]['entityId']
                        }

                        element.src = imageUrl;
                    }
                    else{
                        console.dir('Status : ' + xobj.status + ' for image ' + image_name);
                        element.src = 'icons/question-circle-solid.svg'
                    }
                }
            };
            xobj.send(null);
        }

        function getImageName(id, neighbourNumber){
            var xobj = new XMLHttpRequest();
            xobj.overrideMimeType("application/json");
            xobj.open('GET', 'http://localhost:5000/image_name/' + id, true); // Replace 'my_data' with the path to your file
            xobj.onreadystatechange = function () {
                if (xobj.readyState === 4 && xobj.status === 200) {
                    // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
                    var imageElement = document.querySelector('#neighbour-' + String(neighbourNumber + 1));
                    var image_data = JSON.parse(xobj.responseText);
                    setImage(image_data[0], imageElement);
                }
            };
            xobj.send(null);
        }

        function getCurrentImageNameAndNeighbours(){
            var xobj = new XMLHttpRequest();
            xobj.overrideMimeType("application/json");
            xobj.open('GET', 'http://localhost:5000/image_name_and_neighbours/' + selected_image, true); // Replace 'my_data' with the path to your file
            xobj.onreadystatechange = function () {
                if (xobj.readyState === 4 && xobj.status === 200) {
                    // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
                    var image_data = JSON.parse(xobj.responseText);
                    var main_image_element = document.querySelector('#main-image');
                    setImage(image_data[0], main_image_element);
                    for(var i = 0; i < 20; i++)
                    {
                        getImageName(image_data[1][i]['id'], i);
                    }
                }
            };
            xobj.send(null);
        }

        function init() {

            var xobj = new XMLHttpRequest();
            xobj.overrideMimeType("application/json");
            xobj.open('GET', 'http://localhost:5000/image_count', true); // Replace 'my_data' with the path to your file
            xobj.onreadystatechange = function () {
                if (xobj.readyState === 4 && xobj.status === 200) {
                    // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
                    image_count = JSON.parse(xobj.responseText);
                    selected_image = 1;
                    getCurrentImageNameAndNeighbours()
                    //updateDisplayedImage()
                }
            };
            xobj.send(null);
        }

        function decreaseImageIndex(){
            selected_image -= 1;
            if(selected_image < 1)
                selected_image = 1;
            getCurrentImageNameAndNeighbours()
        }

        function setRandomImage(){
            selected_image = Math.floor(Math.random()*image_count);
            getCurrentImageNameAndNeighbours()
        }

        function increaseImageIndex(){
            selected_image += 1;
            if(selected_image > image_count){
                selected_image = image_count
            }
            getCurrentImageNameAndNeighbours()
        }

        init()
    </script>

</head>

<body>

<div>
    <button onclick="decreaseImageIndex()">Previous</button>
    <button onclick="setRandomImage()">Random</button>
    <button onclick="increaseImageIndex()">Next</button>
</div>

<div>
    <img id="main-image" src="">
</div>

<div>

    <img class="neighbour" id="neighbour-1" src="">
    <img class="neighbour" id="neighbour-2" src="">
    <img class="neighbour" id="neighbour-3" src="">
    <img class="neighbour" id="neighbour-4" src="">
    <img class="neighbour" id="neighbour-5" src="">
    <img class="neighbour" id="neighbour-6" src="">
    <img class="neighbour" id="neighbour-7" src="">
    <img class="neighbour" id="neighbour-8" src="">
    <img class="neighbour" id="neighbour-9" src="">
    <img class="neighbour" id="neighbour-10" src="">
    <img class="neighbour" id="neighbour-11" src="">
    <img class="neighbour" id="neighbour-12" src="">
    <img class="neighbour" id="neighbour-13" src="">
    <img class="neighbour" id="neighbour-14" src="">
    <img class="neighbour" id="neighbour-15" src="">
    <img class="neighbour" id="neighbour-16" src="">
    <img class="neighbour" id="neighbour-17" src="">
    <img class="neighbour" id="neighbour-18" src="">
    <img class="neighbour" id="neighbour-19" src="">
    <img class="neighbour" id="neighbour-20" src="">
</div>

</body>

</html>