<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>Image processing demo</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
          integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
          crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
          integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
          crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
          integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
          crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css"
        integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">

  <style type="text/css">
    img#main-image {
      height: 500px;
      width: auto;
    }

    img.neighbour {
      height: 150px;
    }
  </style>

  <script typeof="text/javascript">
    var imageCount = 0;
    var selectedImageId = -1;
    var arachnePath = 'https://arachne.dainst.org';
    // var flaskPath = 'data/'; // Deployment
    var flaskPath = 'http://localhost:5000/'; // Development
    var hashRegex = /#(\d+)/;

    function setMainImage(imageName, imageUrl, element) {
      var imageElement = element.querySelector('img');
      var linkElement = element.querySelector('a');

      if (imageUrl === null) {
        imageUrl = 'icons/key-solid.svg';
      }

      imageElement.src = imageUrl;
      linkElement.innerHTML = "<i class=\"fas fa-external-link-alt\"></i> " + imageName;
      linkElement.href = arachnePath + '/search?q=' + imageName;
    }

    function setNeighbourImage(imageId, imageName, imageUrl, element) {
      var imageElement = element.querySelector('img');

      if (imageUrl === null) {
        imageUrl = 'icons/key-solid.svg';
      }

      imageElement.src = imageUrl;
      element.onclick = function () {
        updateHash(imageId);
      };
    }

    function getCurrentImageNameAndNeighbours() {

      setPlaceHolders();

      var xobj = new XMLHttpRequest();
      xobj.overrideMimeType('application/json');
      xobj.open('GET', flaskPath + 'image_name_and_neighbours/' + selectedImageId, true);
      xobj.onreadystatechange = function () {
        if (xobj.readyState === 4 && xobj.status === 200) {
          var imageData = JSON.parse(xobj.responseText);
          var mainImageElement = document.querySelector('#main-card');

          if (imageData.length === 0) {
            // TODO: High ID images get empty results from service
            console.log('No data for image #' + selectedImageId + "!");
            return;
          }

          setMainImage(imageData[0], imageData[1], mainImageElement);

          for (var i = 0; i < 9; i++) {
            setNeighbourImage(
                    imageData[2][i].id,
                    imageData[2][i].name,
                    imageData[2][i].url,
                    document.querySelector('#neighbour-' + String(i + 1)));

            setNeighbourImage(
                    imageData[3][i].id,
                    imageData[3][i].name,
                    imageData[3][i].url,
                    document.querySelector('#neighbour-uncompressed-' + String(i + 1)));
          }
        }
      };
      xobj.send(null);
    }

    function readHash() {
      if (window.location.hash) {
        selectedImageId = hashRegex.exec(window.location.hash)[1];
        if (selectedImageId > imageCount) {
          selectedImageId = imageCount;
        } else if (selectedImageId < 1) {
          selectedImageId = 1;
        }
      } else {
        console.log('No hash, setting to first image...');
        selectedImageId = 1;
      }
    }

    function updateHash(id) {
      window.location.hash = '#' + id;
    }

    function setPlaceHolders() {
      var image_elements = document.querySelectorAll('img');

      for (var i = 0; i < image_elements.length; i++) {
        image_elements[i].src = 'https://arachne.dainst.org/img/placeholder/placeholderNoImage.png';
      }
    }

    window.onhashchange = function () {
      var value = hashRegex.exec(window.location.hash)[1];

      if (value > imageCount) {
        selectedImageId = imageCount;
      } else if (value < 1) {
        selectedImageId = 1;
      } else {
        selectedImageId = value;
      }
      getCurrentImageNameAndNeighbours();
    };

    function init() {

      var xobj = new XMLHttpRequest();
      xobj.overrideMimeType('application/json');
      xobj.open('GET', flaskPath + 'image_count', true);
      xobj.onreadystatechange = function () {
        if (xobj.readyState === 4 && xobj.status === 200) {
          imageCount = JSON.parse(xobj.responseText);
          readHash();
          getCurrentImageNameAndNeighbours()
        }
      };
      xobj.send(null);
    }

    function decreaseImageIndex() {
      var newValue = parseInt(selectedImageId) - 1;
      if (newValue < 1) {
        newValue = 1;
      }
      updateHash(newValue);
    }

    function setRandomImage() {
      var newValue = Math.floor(Math.random() * imageCount);
      updateHash(newValue);
    }

    function increaseImageIndex() {
      var newValue = parseInt(selectedImageId) + 1;
      if (newValue > imageCount) {
        newValue = imageCount
      }
      updateHash(newValue);
    }

    init()
  </script>

</head>

<body>

<div class="container-fluid">

  <br/>
  <div class="row justify-content-center">
    <div class="btn-group" role="group" aria-label="Basic example">
      <button type="button" class="btn btn-primary" onclick="decreaseImageIndex()">Previous</button>
      <button type="button" class="btn btn-primary" onclick="setRandomImage()">Random</button>
      <button type="button" class="btn btn-primary" onclick="increaseImageIndex()">Next</button>
    </div>
  </div>

  <br/>
  <div class="row justify-content-center">
    <div class="card" id="main-card">
      <img class="img-fluid card-img-top" alt="Main image" id="main-image" src="">
      <div class="card-body">
        <h5 class="card-title">
          <a href="" id="main-link" target="_blank"></a></h5>
      </div>
    </div>
  </div>

  <br/>
  <div class="row">
    <div class="col-md-6">
      <h3>Compressed</h3>
      <footer class="blockquote-footer">32 feature values per image</footer>

      <span id="neighbour-1"><img class="neighbour" src=""></span>
      <span id="neighbour-2"><img class="neighbour" src=""></span>
      <span id="neighbour-3"><img class="neighbour" src=""></span>
      <span id="neighbour-4"><img class="neighbour" src=""></span>
      <span id="neighbour-5"><img class="neighbour" src=""></span>
      <span id="neighbour-6"><img class="neighbour" src=""></span>
      <span id="neighbour-7"><img class="neighbour" src=""></span>
      <span id="neighbour-8"><img class="neighbour" src=""></span>
      <span id="neighbour-9"><img class="neighbour" src=""></span>
    </div>
    <div class="col-md-6">
      <h3>Uncompressed</h3>
      <footer class="blockquote-footer">2048 feature values per image</footer>
      <span id="neighbour-uncompressed-1"><img class="neighbour" src=""/></span>
      <span id="neighbour-uncompressed-2"><img class="neighbour" src=""></span>
      <span id="neighbour-uncompressed-3"><img class="neighbour" src=""></span>
      <span id="neighbour-uncompressed-4"><img class="neighbour" src=""></span>
      <span id="neighbour-uncompressed-5"><img class="neighbour" src=""></span>
      <span id="neighbour-uncompressed-6"><img class="neighbour" src=""></span>
      <span id="neighbour-uncompressed-7"><img class="neighbour" src=""></span>
      <span id="neighbour-uncompressed-8"><img class="neighbour" src=""></span>
      <span id="neighbour-uncompressed-9"><img class="neighbour" src=""></span>
    </div>
  </div>
</div>
</body>

</html>
